---
# Deploy Universal Self-Healing to ALL Services on MiracleMax
#
# Usage:
#   ansible-playbook playbooks/deploy-self-healing.yml
#   ansible-playbook playbooks/deploy-self-healing.yml --check --diff  # Dry run
#
# Philosophy: Ansai - Self-Healing, Observable, Config-as-Code

- name: Deploy Universal Self-Healing System
  hosts: miraclemax
  become: yes
  
  pre_tasks:
    - name: Display deployment banner
      debug:
        msg:
          - "ğŸ¤– â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "   MiracleMax Universal Self-Healing"
          - "   Deployment Starting..."
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "Target: {{ inventory_hostname }}"
          - "Services: {{ (monitored_services | map(attribute='name') | list | join(', ')) if (monitored_services is defined and monitored_services is iterable and monitored_services is not string) else '(using role defaults)' }}"
          - "Owner: {{ owner_email | default('(not configured)') }}"
          - ""
    
    - name: Verify target host is reachable
      ping:
    
    - name: Check systemd availability
      command: systemctl --version
      register: systemd_version
      changed_when: false
    
    - name: Display systemd version
      debug:
        msg: "Systemd version: {{ systemd_version.stdout_lines[0] | default('check mode') }}"
      when: systemd_version.stdout_lines | length > 0
  
  roles:
    - role: universal_self_heal
      tags: ['self-heal', 'monitoring']
  
  post_tasks:
    - name: Verify self-healing deployment
      stat:
        path: "/usr/local/bin/self-heal/{{ item.name }}-self-heal.sh"
      loop: "{{ monitored_services }}"
      register: heal_scripts
      failed_when: not heal_scripts.stat.exists
    
    - name: Display deployment summary
      debug:
        msg:
          - ""
          - "âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "   Universal Self-Healing Deployed!"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“Š Configuration:"
          - "   â€¢ Monitored services: {{ monitored_services | length }}"
          - "   â€¢ Self-healing: {{ 'ENABLED' if self_healing_enabled else 'DISABLED' }}"
          - "   â€¢ Alert email: {{ owner_email }}"
          - "   â€¢ Failure threshold: {{ failure_threshold }}"
          - ""
          - "ğŸ”§ Commands:"
          - "   â€¢ View status: miraclemax-status"
          - "   â€¢ View logs: journalctl -t miraclemax-self-heal"
          - "   â€¢ Test healing: sudo systemctl stop story-stages"
          - ""
          - "ğŸ“§ You will receive emails when:"
          - "   â€¢ A service fails and is automatically healed"
          - "   â€¢ Healing fails and manual intervention is needed"
          - "   â€¢ Any critical service experiences issues"
          - ""
          - "ğŸ¤– Self-healing is now active for all services!"
          - ""


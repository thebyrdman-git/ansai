---
# Deploy Universal Self-Healing System
#
# Usage:
#   ansible-playbook playbooks/deploy-self-healing.yml -i inventory/hosts.yml
#   ansible-playbook playbooks/deploy-self-healing.yml -i inventory/hosts.yml --check --diff  # Dry run
#
# With custom services:
#   ansible-playbook playbooks/deploy-self-healing.yml -i inventory/hosts.yml \
#     -e 'monitored_services=[{"name": "nginx", "port": 80, "critical": true}]'
#
# Philosophy: Ansai - Self-Healing, Observable, Config-as-Code

- name: Deploy Universal Self-Healing System
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  
  pre_tasks:
    - name: Display deployment banner
      debug:
        msg:
          - "ğŸ¤– â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "   ANSAI Universal Self-Healing"
          - "   Deployment Starting..."
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "Target: {{ inventory_hostname }}"
          - "Services: {{ (monitored_services | default([])) if (monitored_services is iterable and monitored_services is not string) else '(using role defaults)' }}"
          - "Owner: {{ owner_email | default('(not set)') }}"
          - ""
    
    - name: Verify target host is reachable
      ping:
    
    - name: Check systemd availability
      command: systemctl --version
      register: systemd_version
      changed_when: false
    
    - name: Display systemd version
      debug:
        msg: "Systemd version: {{ systemd_version.stdout_lines[0] | default('check mode') }}"
      when: systemd_version.stdout_lines | length > 0
  
  roles:
    - role: universal_self_heal
      tags: ['self-heal', 'monitoring']
  
  post_tasks:
    - name: Verify self-healing deployment
      stat:
        path: "/usr/local/bin/self-heal/{{ item.name }}-self-heal.sh"
      loop: "{{ monitored_services | default([]) }}"
      register: heal_scripts
      when: monitored_services is defined and monitored_services | length > 0
    
    - name: Display deployment summary
      debug:
        msg:
          - ""
          - "âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "   ANSAI Universal Self-Healing Deployed!"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“Š Configuration:"
          - "   â€¢ Monitored services: {{ monitored_services | default([]) | length }}"
          - "   â€¢ Self-healing: {{ 'ENABLED' if (self_healing_enabled | default(true)) else 'DISABLED' }}"
          - "   â€¢ Alert email: {{ owner_email | default('(not configured)') }}"
          - "   â€¢ Failure threshold: {{ failure_threshold | default(3) }}"
          - ""
          - "ğŸ”§ Commands:"
          - "   â€¢ View logs: journalctl -t ansai-self-heal"
          - "   â€¢ Test healing: sudo systemctl stop <service-name>"
          - ""
          - "ğŸ“§ Alerts (if email configured):"
          - "   â€¢ Service fails and is automatically healed"
          - "   â€¢ Healing fails and manual intervention needed"
          - ""
          - "ğŸ¤– Self-healing is now active!"
          - ""


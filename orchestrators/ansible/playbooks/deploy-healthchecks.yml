---
# Deploy Healthchecks.io External Monitoring
# Dead Man's Switch for TestServer
#
# Usage:
#   ansible-playbook playbooks/deploy-healthchecks.yml
#
# Philosophy: Ansai - Observable, Self-Healing, Config-as-Code

- name: Deploy Healthchecks.io External Monitoring
  hosts: testserver
  become: yes
  
  pre_tasks:
    - name: Display deployment banner
      debug:
        msg:
          - "ğŸ«€ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "   TestServer External Monitoring"
          - "   Healthchecks.io Integration"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "Target: {{ inventory_hostname }}"
          - "This adds external monitoring for complete coverage"
          - ""
    
    - name: Verify target host is reachable
      ping:
  
  roles:
    - role: healthchecks_monitoring
      tags: ['healthchecks', 'monitoring', 'external']
  
  post_tasks:
    - name: Verify heartbeat script exists
      stat:
        path: /usr/local/bin/testserver-heartbeat
      register: heartbeat_script
      when: healthcheck_enabled and healthcheck_ping_url != ""
    
    - name: Verify cron job is installed
      command: crontab -l
      register: cron_check
      changed_when: false
      failed_when: false
      when: healthcheck_enabled and healthcheck_ping_url != ""
    
    - name: Display final summary
      debug:
        msg:
          - ""
          - "âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "   External Monitoring Complete!"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ¯ Coverage:"
          - "   â€¢ Self-healing: 95% of failures (automatic)"
          - "   â€¢ Healthchecks.io: 5% of failures (escalation)"
          - "   â€¢ Combined: 100% coverage âœ…"
          - ""
          - "ğŸ“§ You'll get emails when:"
          - "   â€¢ Self-healing fixes an issue (detailed report)"
          - "   â€¢ Server stops responding (ANY reason)"
          - "   â€¢ Heartbeat stops (server down, systemd dead, etc.)"
          - ""
          - "ğŸ«€ Heartbeat active: Every {{ healthcheck_interval / 60 }} minutes"
          - ""
          - "ğŸ‰ TestServer is now fully observable and self-healing!"
          - ""
      when: heartbeat_script.stat.exists | default(false)


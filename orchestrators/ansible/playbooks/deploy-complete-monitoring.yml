---
# Deploy Complete Monitoring Stack
# Self-Healing + External Monitoring = 100% Coverage
#
# Usage:
#   ansible-playbook playbooks/deploy-complete-monitoring.yml
#
# Philosophy: Ansai - Observable, Self-Healing, Config-as-Code

- name: Deploy Complete Monitoring Stack for MiracleMax
  hosts: miraclemax
  become: yes
  
  pre_tasks:
    - name: Display deployment banner
      debug:
        msg:
          - "ğŸ¤– â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "   MiracleMax Complete Monitoring Stack"
          - "   Self-Healing + External Monitoring"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "Target: {{ inventory_hostname }}"
          - "This deploys the COMPLETE observable stack"
          - ""
    
    - name: Verify target host is reachable
      ping:
  
  roles:
    - role: universal_self_heal
      tags: ['self-heal', 'monitoring', 'internal']
    
    - role: healthchecks_monitoring
      tags: ['healthchecks', 'monitoring', 'external']
  
  post_tasks:
    - name: Display complete stack summary
      debug:
        msg:
          - ""
          - "âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "   Complete Monitoring Stack Deployed!"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“Š Two-Layer Protection:"
          - ""
          - "Layer 1: Self-Healing (Internal)"
          - "   â€¢ Automatic detection of service failures"
          - "   â€¢ 95% of issues fixed automatically"
          - "   â€¢ Detailed email reports after each fix"
          - "   â€¢ Healing time: ~5-15 seconds"
          - ""
          - "Layer 2: Healthchecks.io (External)"
          - "   â€¢ Dead man's switch (expects regular pings)"
          - "   â€¢ Detects: Server down, systemd failure, network issues"
          - "   â€¢ Alerts if heartbeat stops for ANY reason"
          - "   â€¢ Catches the 5% that self-healing can't"
          - ""
          - "ğŸ¯ Combined Coverage: 100%"
          - ""
          - "ğŸ“§ Email Notifications:"
          - "   â€¢ Self-healing: Detailed reports when issues are fixed"
          - "   â€¢ Healthchecks: Alerts when server stops responding"
          - "   â€¢ Sent to: {{ owner_email | default(healthcheck_alert_email) }}"
          - ""
          - "ğŸ”§ Commands:"
          - "   â€¢ Status dashboard: miraclemax-status"
          - "   â€¢ Self-heal logs: journalctl -t miraclemax-self-heal"
          - "   â€¢ Heartbeat logs: tail -f /var/log/healthcheck-heartbeat.log"
          - "   â€¢ Test heartbeat: sudo /usr/local/bin/miraclemax-heartbeat"
          - ""
          - "ğŸ‰ MiracleMax is now fully observable and self-healing!"
          - ""
          - "Philosophy: Ansai âœ…"
          - "   â€¢ Observable (comprehensive logging + alerts)"
          - "   â€¢ Self-Healing (automatic recovery)"
          - "   â€¢ Config-as-Code (all in Ansible)"
          - ""


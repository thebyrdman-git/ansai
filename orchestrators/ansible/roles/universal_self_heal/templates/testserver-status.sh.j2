#!/bin/bash
# TestServer Universal Status Dashboard
# Shows health of all monitored services

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Header
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘              ğŸ¤– TestServer Self-Healing Status                â•‘${NC}"
echo -e "${BLUE}â•‘              {{ inventory_hostname }}                          â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# System overview
echo -e "${CYAN}ğŸ“Š System Overview:${NC}"
echo -e "   Time: $(date)"
echo -e "   Uptime: $(uptime -p)"
echo -e "   Load: $(uptime | awk -F'load average:' '{print $2}')"
echo -e "   Memory: $(free -h | awk '/^Mem:/ {print $3 " / " $2 " (" int($3/$2*100) "%)"}')"
echo -e "   Disk: $(df -h / | awk 'NR==2 {print $3 " / " $2 " (" $5 ")"}')"
echo ""

# Service health
echo -e "${CYAN}ğŸ”§ Service Health:${NC}"
echo ""

TOTAL_SERVICES={{ monitored_services | length }}
RUNNING_SERVICES=0
FAILED_SERVICES=0
INACTIVE_SERVICES=0

{% for service in monitored_services %}
# Check {{ service.name }}
SERVICE_NAME="{{ service.name }}"
# Pad service name to 20 characters
SERVICE_DISPLAY=$(printf "%-20s" "$SERVICE_NAME")

if systemctl is-active --quiet {{ service.name }}; then
    echo -e "   ${GREEN}âœ…${NC} $SERVICE_DISPLAY ACTIVE    {% if service.port %}Port: {{ service.port }}{% endif %} {% if service.domain %}({{ service.domain }}){% endif %}"
    ((RUNNING_SERVICES++))
elif systemctl is-failed --quiet {{ service.name }}; then
    echo -e "   ${RED}âŒ${NC} $SERVICE_DISPLAY FAILED    {% if service.critical %}âš ï¸  CRITICAL{% endif %}"
    ((FAILED_SERVICES++))
else
    echo -e "   ${YELLOW}â¸ï¸${NC} $SERVICE_DISPLAY INACTIVE"
    ((INACTIVE_SERVICES++))
fi

# Check if self-healing has run recently
HEAL_STATUS="/var/run/{{ service.name }}-heal-status"
if [ -f "$HEAL_STATUS" ]; then
    LAST_HEAL=$(grep "last_heal=" "$HEAL_STATUS" | cut -d'=' -f2)
    HEAL_STATUS_VAL=$(grep "last_status=" "$HEAL_STATUS" | cut -d'=' -f2)
    
    if [ -n "$LAST_HEAL" ]; then
        HEAL_AGO=$(($(date +%s) - $LAST_HEAL))
        if [ $HEAL_AGO -lt 3600 ]; then
            HEAL_TIME="$(($HEAL_AGO / 60))m ago"
        elif [ $HEAL_AGO -lt 86400 ]; then
            HEAL_TIME="$(($HEAL_AGO / 3600))h ago"
        else
            HEAL_TIME="$(($HEAL_AGO / 86400))d ago"
        fi
        
        if [ "$HEAL_STATUS_VAL" = "RESOLVED" ]; then
            echo -e "      ${GREEN}â†³ Last healing: $HEAL_TIME - $HEAL_STATUS_VAL${NC}"
        else
            echo -e "      ${YELLOW}â†³ Last healing: $HEAL_TIME - $HEAL_STATUS_VAL${NC}"
        fi
    fi
fi

{% endfor %}

echo ""
echo -e "${CYAN}Summary:${NC} ${GREEN}$RUNNING_SERVICES running${NC}, ${RED}$FAILED_SERVICES failed${NC}, ${YELLOW}$INACTIVE_SERVICES inactive${NC}"
echo ""

# Recent healing activity
echo -e "${CYAN}ğŸ”„ Recent Self-Healing Activity:${NC}"
HEAL_COUNT=$(journalctl -t testserver-self-heal --since "24 hours ago" 2>/dev/null | grep -c "Self-Healing Report" || echo "0")

if [ "$HEAL_COUNT" -eq 0 ]; then
    echo -e "   ${GREEN}âœ… No healing attempts in last 24 hours${NC}"
else
    echo -e "   ${YELLOW}âš ï¸  $HEAL_COUNT healing attempt(s) in last 24 hours${NC}"
    echo ""
    echo "   Recent healing events:"
    journalctl -t testserver-self-heal --since "24 hours ago" --no-pager 2>/dev/null | \
        grep -E "RESOLVED|FAILED" | tail -n 5 | sed 's/^/   /'
fi

echo ""

# Failed service details
if [ $FAILED_SERVICES -gt 0 ]; then
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘                    âš ï¸  FAILURES DETECTED  âš ï¸                   â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    {% for service in monitored_services %}
    if systemctl is-failed --quiet {{ service.name }}; then
        echo -e "${RED}Service: {{ service.name }}${NC}"
        echo "Status:"
        systemctl status {{ service.name }} --no-pager --lines=5 | sed 's/^/  /'
        echo ""
        echo "Last 3 log entries:"
        journalctl -u {{ service.name }} -n 3 --no-pager | sed 's/^/  /'
        echo ""
        echo -e "${YELLOW}Actions:${NC}"
        echo "  â€¢ View logs: journalctl -u {{ service.name }} -n 100"
        echo "  â€¢ Check healing: journalctl -u {{ service.name }}-self-heal -n 20"
        echo "  â€¢ Manual restart: sudo systemctl restart {{ service.name }}"
        echo ""
    fi
    {% endfor %}
fi

# Quick actions
echo -e "${CYAN}ğŸ”§ Quick Actions:${NC}"
echo "   View all service logs:     journalctl -t testserver-self-heal -f"
echo "   View specific service:     journalctl -u <service-name> -f"
echo "   Test self-healing:         sudo systemctl stop <service-name>"
echo "   Force heal attempt:        sudo systemctl start <service-name>-self-heal"
echo "   Disable self-healing:      sudo systemctl mask <service-name>-self-heal"
echo ""

# Self-healing status
echo -e "${CYAN}ğŸ¤– Self-Healing Configuration:${NC}"
echo "   Status: {{ 'ENABLED' if self_healing_enabled else 'DISABLED' }}"
echo "   Monitored services: {{ monitored_services | length }}"
echo "   Owner: {{ owner_email }}"
echo "   Failure threshold: {{ failure_threshold }} attempts"
echo ""

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"


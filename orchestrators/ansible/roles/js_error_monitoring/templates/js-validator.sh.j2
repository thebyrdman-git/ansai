#!/bin/bash
# JavaScript Template Validator
# Automatically checks templates for JavaScript syntax errors
# Part of the miraclemax self-healing infrastructure

set -euo pipefail

# Configuration
LOG_DIR="/var/log/js-validation"
ERROR_LOG="${LOG_DIR}/errors.log"
LAST_ALERT_FILE="${LOG_DIR}/last_alert"
ALERT_COOLDOWN=3600  # 1 hour between similar alerts

# Email configuration
OWNER_EMAIL="{{ owner_email }}"
SMTP_SERVER="{{ smtp_server }}"
SMTP_PORT="{{ smtp_port }}"
SMTP_USER="{{ smtp_user }}"
SMTP_PASSWORD="{{ smtp_password }}"

# Ensure log directory exists
mkdir -p "${LOG_DIR}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Validation results
ERRORS_FOUND=0
VALIDATION_RESULTS=""

# Function to send email alert
send_alert() {
    local subject="$1"
    local body="$2"
    
    # Check cooldown
    if [[ -f "${LAST_ALERT_FILE}" ]]; then
        local last_alert=$(cat "${LAST_ALERT_FILE}")
        local current_time=$(date +%s)
        local time_diff=$((current_time - last_alert))
        
        if [[ ${time_diff} -lt ${ALERT_COOLDOWN} ]]; then
            echo "Alert on cooldown (${time_diff}s / ${ALERT_COOLDOWN}s)"
            return
        fi
    fi
    
    # Send email using Python
    python3 << PYEOF
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import sys

try:
    msg = MIMEMultipart()
    msg['From'] = "${SMTP_USER}"
    msg['To'] = "${OWNER_EMAIL}"
    msg['Subject'] = "${subject}"
    
    body = """${body}"""
    msg.attach(MIMEText(body, 'plain'))
    
    server = smtplib.SMTP("${SMTP_SERVER}", ${SMTP_PORT})
    server.starttls()
    server.login("${SMTP_USER}", "${SMTP_PASSWORD}")
    server.send_message(msg)
    server.quit()
    
    print("‚úÖ Alert sent successfully")
    sys.exit(0)
except Exception as e:
    print(f"‚ùå Failed to send alert: {e}")
    sys.exit(1)
PYEOF
    
    # Update last alert timestamp
    date +%s > "${LAST_ALERT_FILE}"
}

# Function to validate JavaScript in a file
validate_js_in_file() {
    local file="$1"
    local app_name="$2"
    
    # Extract JavaScript blocks from HTML templates
    # Look for <script> blocks and check for common syntax errors
    
    # Check for unescaped quotes in JavaScript strings
    local unescaped_quotes=$(grep -n "'\\\\'[a-z]" "${file}" 2>/dev/null || true)
    if [[ -n "${unescaped_quotes}" ]]; then
        ERRORS_FOUND=$((ERRORS_FOUND + 1))
        VALIDATION_RESULTS="${VALIDATION_RESULTS}\n‚ùå [${app_name}] ${file}:"
        VALIDATION_RESULTS="${VALIDATION_RESULTS}\n   Potential unescaped quote issue:"
        VALIDATION_RESULTS="${VALIDATION_RESULTS}\n   ${unescaped_quotes}"
    fi
    
    # Check for mismatched braces in script blocks
    local in_script=0
    local brace_count=0
    local line_num=0
    
    while IFS= read -r line; do
        line_num=$((line_num + 1))
        
        if [[ "${line}" =~ \<script\> ]]; then
            in_script=1
            brace_count=0
        fi
        
        if [[ ${in_script} -eq 1 ]]; then
            # Count opening and closing braces
            local opening=$(echo "${line}" | grep -o '{' | wc -l)
            local closing=$(echo "${line}" | grep -o '}' | wc -l)
            brace_count=$((brace_count + opening - closing))
        fi
        
        if [[ "${line}" =~ \</script\> ]]; then
            if [[ ${brace_count} -ne 0 ]]; then
                ERRORS_FOUND=$((ERRORS_FOUND + 1))
                VALIDATION_RESULTS="${VALIDATION_RESULTS}\n‚ùå [${app_name}] ${file}:"
                VALIDATION_RESULTS="${VALIDATION_RESULTS}\n   Mismatched braces in script block (balance: ${brace_count})"
            fi
            in_script=0
        fi
    done < "${file}"
}

# Function to validate an application
validate_app() {
    local app_name="$1"
    local template_dirs="$2"
    
    echo -e "${YELLOW}üîç Validating ${app_name}...${NC}"
    
    # Split template directories and validate each
    IFS=',' read -ra DIRS <<< "${template_dirs}"
    for dir in "${DIRS[@]}"; do
        if [[ ! -d "${dir}" ]]; then
            echo -e "${RED}   ‚ö†Ô∏è  Directory not found: ${dir}${NC}"
            continue
        fi
        
        # Find all HTML/template files
        while IFS= read -r -d '' file; do
            # Check if file contains <script> tags
            if grep -q "<script>" "${file}"; then
                validate_js_in_file "${file}" "${app_name}"
            fi
        done < <(find "${dir}" -type f \( -name "*.html" -o -name "*.jinja2" -o -name "*.j2" \) -print0)
    done
}

# Main validation loop
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üîç JavaScript Template Validation"
echo "   $(date '+%Y-%m-%d %H:%M:%S')"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

{% for app in monitored_apps %}
validate_app "{{ app.name }}" "{{ app.template_dirs | join(',') }}"
{% endfor %}

# Report results
echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

if [[ ${ERRORS_FOUND} -eq 0 ]]; then
    echo -e "${GREEN}‚úÖ No JavaScript errors detected${NC}"
    exit 0
else
    echo -e "${RED}‚ùå Found ${ERRORS_FOUND} potential JavaScript errors${NC}"
    echo -e "${VALIDATION_RESULTS}"
    
    # Log errors
    {
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "Validation Report: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "Errors Found: ${ERRORS_FOUND}"
        echo -e "${VALIDATION_RESULTS}"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    } >> "${ERROR_LOG}"
    
    # Send alert
    send_alert \
        "üö® JavaScript Validation Errors Detected on miraclemax" \
        "JavaScript validation has detected ${ERRORS_FOUND} potential errors in your templates.

VALIDATION REPORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${VALIDATION_RESULTS}

SYSTEM INFO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Host: miraclemax.local
Timestamp: $(date '+%Y-%m-%d %H:%M:%S')
Log: ${ERROR_LOG}

RECOMMENDED ACTION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Review the errors above and fix any JavaScript syntax issues in your templates.

Your ansai workflows are protecting you! üõ°Ô∏è"
    
    exit 1
fi


#!/bin/bash
# ansai-dev-switch - Switch between ANSAI development projects
# Usage: ansai-dev-switch <project>
#
# Projects:
#   community  - Community ANSAI (Github)
#   rh         - RH Internal ANSAI (GitLab CEE)
#   bugnosis   - Bugnosis (GitHub)

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

# Configuration
REPOS_DIR="$HOME"
JIRA_CLI="$HOME/ansai-community/bin/ansai-jira"

# Projects Configuration
get_project_dir() {
    case "$1" in
        "community") echo "$REPOS_DIR/ansai-community" ;;
        "rh")        echo "$REPOS_DIR/ansai-redhat" ;;
        "bugnosis")  echo "$REPOS_DIR/bugnosis" ;;
        "finance")   echo "$REPOS_DIR/finance" ;;
        *)           echo "" ;;
    esac
}

get_jira_key() {
    case "$1" in
        "community") echo "ANSAIPUB" ;;
        "rh")        echo "RHANSAI" ;;
        "bugnosis")  echo "BUGNOSIS" ;;
        *)           echo "" ;;
    esac
}

print_header() {
    echo -e "\n${BLUE}${BOLD}═══════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}${BOLD}  Switching to: $1${NC}"
    echo -e "${BLUE}${BOLD}═══════════════════════════════════════════════════${NC}\n"
}

print_step() { echo -e "${BOLD}→ $1${NC}"; }
print_success() { echo -e "${GREEN}✅ $1${NC}"; }
print_error() { echo -e "${RED}❌ $1${NC}"; }

# Check args
if [[ $# -eq 0 ]]; then
    echo "Usage: ansai-dev-switch <project>"
    echo "Projects: community, rh, bugnosis"
    exit 1
fi

TARGET="$1"
DIR=$(get_project_dir "$TARGET")
JIRA_KEY=$(get_jira_key "$TARGET")

if [[ -z "$DIR" ]]; then
    print_error "Unknown project: $TARGET"
    echo "Available: community, rh, bugnosis"
    exit 1
fi

print_header "$TARGET"

# 1. Switch Directory
if [[ -d "$DIR" ]]; then
    print_step "Switching to directory: $DIR"
    # We can't cd the parent shell from a script, so we output instruction
    echo -e "${YELLOW}Run this to switch directory:${NC}"
    echo "cd $DIR"
else
    print_error "Directory not found: $DIR"
    # Clone if missing?
    if [[ "$TARGET" == "bugnosis" ]]; then
        print_step "Cloning Bugnosis..."
        git clone git@github.com:thebyrdman-git/bugnosis.git "$DIR"
    fi
fi

# 2. Git Status
if [[ -d "$DIR" ]]; then
    print_step "Git Status"
    cd "$DIR"
    git status -sb
    echo ""
fi

# 3. Jira Tasks
if [[ -n "$JIRA_KEY" ]] && [[ -x "$JIRA_CLI" ]]; then
    print_step "Checking Jira Tasks ($JIRA_KEY)..."
    # Only run if configured and working
    if "$JIRA_CLI" list "$JIRA_KEY" 2>/dev/null; then
        : # Success
    else
        echo "Tip: Use the Jira extension in Cursor sidebar to view tasks."
    fi
fi

# 4. Open Project
print_step "Opening in Cursor..."
if command -v cursor &>/dev/null; then
    cursor "$DIR"
fi

print_success "Context switched!"


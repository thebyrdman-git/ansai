#!/bin/bash
# ANSAI Development Tools Installation Script
# Installs recommended development tools for ANSAI contributors

set -e

# Colors for output (ANSAI standard)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Function to print colored output (ANSAI standard)
print_header() {
    echo -e "\n${BLUE}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}${BOLD}  $1${NC}"
    echo -e "${BLUE}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ ERROR: $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  WARNING: $1${NC}"
}

print_info() {
    echo -e "${CYAN}â„¹ï¸  $1${NC}"
}

print_step() {
    echo -e "${BOLD}â†’ $1${NC}"
}

# Function to check if command exists (ANSAI standard)
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to install brew package if not installed
install_brew_package() {
    local package=$1
    local description=$2
    
    if command_exists "$package"; then
        print_success "$description already installed"
    else
        print_step "Installing $description..."
        if brew install "$package"; then
            print_success "$description installed"
        else
            print_error "Failed to install $description"
            return 1
        fi
    fi
}

# Function to install brew cask if not installed
install_brew_cask() {
    local cask=$1
    local description=$2
    local check_cmd=${3:-$cask}
    
    if command_exists "$check_cmd" || brew list --cask "$cask" &>/dev/null; then
        print_success "$description already installed"
    else
        print_step "Installing $description..."
        if brew install --cask "$cask"; then
            print_success "$description installed"
        else
            print_error "Failed to install $description"
            return 1
        fi
    fi
}

# Function to install pip package using uv (modern Python installer)
install_pip_package() {
    local package=$1
    local description=$2
    local check_cmd=${3:-$package}
    
    if command_exists "$check_cmd"; then
        print_success "$description already installed"
    else
        print_step "Installing $description..."
        # Use uv if available (preferred), otherwise pipx, otherwise pip with break-system-packages
        if command_exists uv; then
            if uv tool install "$package"; then
                print_success "$description installed"
            else
                print_error "Failed to install $description"
                return 1
            fi
        elif command_exists pipx; then
            if pipx install "$package"; then
                print_success "$description installed"
            else
                print_error "Failed to install $description"
                return 1
            fi
        else
            if pip3 install --user --break-system-packages "$package"; then
                print_success "$description installed"
            else
                print_error "Failed to install $description"
                return 1
            fi
        fi
    fi
}

# Start installation
print_header "ANSAI Development Tools Installation"

echo -e "${BOLD}Installing recommended development tools for ANSAI${NC}"
echo -e "This installer will set up your development environment.\n"

# Check prerequisites
print_header "Step 1: Checking Prerequisites"

if ! command_exists brew; then
    print_error "Homebrew not found. Please install it first:"
    echo -e "${CYAN}  /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"${NC}"
    exit 1
fi
print_success "Homebrew installed"

if ! command_exists pip3; then
    print_error "pip3 not found. Please install Python first."
    exit 1
fi
print_success "pip3 installed"

# Essential - Docker
print_header "Step 2: Essential Tools (Docker)"

print_step "Checking Docker..."
if command_exists docker; then
    print_success "Docker already installed"
elif brew list --cask docker-desktop &>/dev/null 2>&1; then
    print_success "Docker Desktop installed (run it to enable docker command)"
else
    print_warning "Docker Desktop requires manual installation with sudo"
    print_info "Run manually: brew install --cask docker-desktop"
    print_info "Or download from: https://www.docker.com/products/docker-desktop/"
fi

# AI Dependencies
print_header "Step 3: AI Dependencies (LiteLLM)"

# Ensure pipx is installed first
if ! command_exists pipx; then
    print_step "Installing pipx..."
    brew install pipx
    pipx ensurepath
fi

print_step "Checking LiteLLM..."
if command_exists litellm || [ -f "$HOME/.local/bin/litellm" ]; then
    print_success "LiteLLM already installed"
else
    print_step "Installing LiteLLM with proxy support..."
    # Use Python 3.11 for compatibility (grpcio doesn't support 3.14 yet)
    if pipx install litellm --python "$(brew --prefix)/bin/python3.11" 2>/dev/null || pipx install litellm; then
        print_success "LiteLLM installed"
    else
        print_error "Failed to install LiteLLM"
    fi
fi

# Ansible/DevOps Tools
print_header "Step 4: Ansible & DevOps Tools"

install_pip_package "ansible-lint" "Ansible Lint" "ansible-lint"
install_brew_package "yamllint" "YAML Lint"

# Python Development
print_header "Step 5: Python Development Tools"

install_brew_package "pyenv" "pyenv (Python version manager)"
install_brew_package "uv" "uv (fast Python package manager)"
install_brew_package "ruff" "Ruff (Python linter/formatter)"

# Documentation Tools
print_header "Step 6: Documentation Tools"

print_step "Checking mkdocs-material..."
if command_exists mkdocs || [ -f "$HOME/.local/bin/mkdocs" ]; then
    print_success "MkDocs Material already installed"
else
    print_step "Installing MkDocs Material..."
    # Use Python 3.11 for compatibility, include deps to get mkdocs command
    if pipx install mkdocs-material --include-deps --python "$(brew --prefix)/bin/python3.11" 2>/dev/null || pipx install mkdocs-material --include-deps; then
        print_success "MkDocs Material installed"
    else
        print_error "Failed to install MkDocs Material"
    fi
fi

install_brew_package "asciinema" "asciinema (terminal recorder)"

# Productivity Tools
print_header "Step 7: Developer Productivity Tools"

install_brew_package "lazygit" "lazygit (Git TUI)"
install_brew_package "direnv" "direnv (per-project env vars)"

# Security Tools
print_header "Step 8: Security & Secrets Tools"

install_brew_package "sops" "SOPS (secrets encryption)"
install_brew_package "age" "age (modern encryption)"

# Installation Summary
print_header "Installation Complete! ðŸŽ‰"

echo -e "${BOLD}Installed Tools Summary:${NC}\n"

# Check what's installed now
echo -e "${CYAN}Essential:${NC}"
command_exists docker && echo -e "  ${GREEN}âœ…${NC} Docker" || echo -e "  ${YELLOW}â³${NC} Docker (open Docker Desktop to complete)"

echo -e "\n${CYAN}AI Dependencies:${NC}"
(command_exists litellm || [ -f "$HOME/.local/bin/litellm" ]) && echo -e "  ${GREEN}âœ…${NC} LiteLLM" || echo -e "  ${RED}âŒ${NC} LiteLLM"

echo -e "\n${CYAN}Ansible/DevOps:${NC}"
command_exists ansible-lint && echo -e "  ${GREEN}âœ…${NC} ansible-lint" || echo -e "  ${RED}âŒ${NC} ansible-lint"
command_exists yamllint && echo -e "  ${GREEN}âœ…${NC} yamllint" || echo -e "  ${RED}âŒ${NC} yamllint"

echo -e "\n${CYAN}Python Development:${NC}"
command_exists pyenv && echo -e "  ${GREEN}âœ…${NC} pyenv" || echo -e "  ${RED}âŒ${NC} pyenv"
command_exists uv && echo -e "  ${GREEN}âœ…${NC} uv" || echo -e "  ${RED}âŒ${NC} uv"
command_exists ruff && echo -e "  ${GREEN}âœ…${NC} ruff" || echo -e "  ${RED}âŒ${NC} ruff"

echo -e "\n${CYAN}Documentation:${NC}"
(command_exists mkdocs || [ -f "$HOME/.local/bin/mkdocs" ]) && echo -e "  ${GREEN}âœ…${NC} mkdocs-material" || echo -e "  ${RED}âŒ${NC} mkdocs-material"
command_exists asciinema && echo -e "  ${GREEN}âœ…${NC} asciinema" || echo -e "  ${RED}âŒ${NC} asciinema"

echo -e "\n${CYAN}Productivity:${NC}"
command_exists lazygit && echo -e "  ${GREEN}âœ…${NC} lazygit" || echo -e "  ${RED}âŒ${NC} lazygit"
command_exists direnv && echo -e "  ${GREEN}âœ…${NC} direnv" || echo -e "  ${RED}âŒ${NC} direnv"

echo -e "\n${CYAN}Security:${NC}"
command_exists sops && echo -e "  ${GREEN}âœ…${NC} sops" || echo -e "  ${RED}âŒ${NC} sops"
command_exists age && echo -e "  ${GREEN}âœ…${NC} age" || echo -e "  ${RED}âŒ${NC} age"

# Ensure ~/.local/bin is in PATH for pipx tools
if ! grep -q '.local/bin' ~/.zshrc 2>/dev/null; then
    echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc
    print_info "Added ~/.local/bin to PATH in ~/.zshrc"
fi

echo -e ""
print_info "Docker Desktop requires manual install: brew install --cask docker"
print_info "For pyenv, add 'eval \"\$(pyenv init -)\"' to your shell profile."
print_info "For direnv, add 'eval \"\$(direnv hook zsh)\"' to your ~/.zshrc."
print_info "Run 'source ~/.zshrc' or open a new terminal to use new tools."

echo -e "\n${GREEN}${BOLD}Your ANSAI development environment is ready! ðŸš€${NC}\n"

exit 0


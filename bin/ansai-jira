#!/bin/bash
# ANSAI Jira CLI - Manage tasks across all ANSAI projects

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

# Config
CONFIG_DIR="$HOME/.config/ansai"
CONFIG_FILE="$CONFIG_DIR/jira.conf"
DEBUG_LOG="$CONFIG_DIR/jira_debug.log"

print_header() { echo -e "\n${BLUE}${BOLD}══ $1 ══${NC}\n"; }
print_error() { echo -e "${RED}❌ $1${NC}"; }

# Load config
load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        source "$CONFIG_FILE"
    fi

    # Priority: Env Var > Keychain > File
    if [[ -n "${JIRA_TOKEN:-}" ]]; then
        TOKEN="$JIRA_TOKEN"
    elif command -v security &>/dev/null; then
        TOKEN=$(security find-generic-password -s "ansai-jira" -w 2>/dev/null || true)
    fi

    # Fallback to file
    if [[ -z "${TOKEN:-}" ]] && [[ -f "$CONFIG_DIR/jira_token" ]]; then
        TOKEN=$(cat "$CONFIG_DIR/jira_token")
    fi

    # Trim whitespace
    TOKEN=$(echo "$TOKEN" | tr -d '\n' | tr -d '\r')
    
    # Support JIRA_USER for Basic Auth
    if [[ -n "${JIRA_USER:-}" ]]; then
        AUTH_HEADER="Authorization: Basic $(echo -n "${JIRA_USER}:${TOKEN}" | base64)"
    else
        AUTH_HEADER="Authorization: Bearer ${TOKEN}"
    fi
}

check_config() {
    if [[ -z "${JIRA_SITE:-}" ]] || [[ -z "${TOKEN:-}" ]]; then
        print_error "Jira not configured. Requires JIRA_SITE and JIRA_TOKEN."
        exit 1
    fi
}

jira_api() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    
    local url="https://${JIRA_SITE}/rest/api/2${endpoint}"
    
    if [[ "${DEBUG:-}" == "true" ]]; then
        echo "--- REQUEST ---" >> "$DEBUG_LOG"
        echo "Method: $method" >> "$DEBUG_LOG"
        echo "URL: $url" >> "$DEBUG_LOG"
        echo "Site: $JIRA_SITE" >> "$DEBUG_LOG"
        echo "Token Length: ${#TOKEN}" >> "$DEBUG_LOG"
    fi

    if [[ -n "$data" ]]; then
        curl -s -v -X "$method" \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            -d "$data" \
            "$url" 2>> "$DEBUG_LOG"
    else
        curl -s -v -X "$method" \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            "$url" 2>> "$DEBUG_LOG"
    fi
}

# Debug command
cmd_debug() {
    check_config
    echo "Debugging connection to $JIRA_SITE..."
    echo "Log file: $DEBUG_LOG"
    echo "--- START DEBUG $(date) ---" > "$DEBUG_LOG"
    
    DEBUG=true jira_api GET "/myself" > /dev/null
    
    if grep -q "HTTP/2 200" "$DEBUG_LOG" || grep -q "HTTP/1.1 200" "$DEBUG_LOG"; then
        print_success "Connection Successful (200 OK)"
        local user=$(jira_api GET "/myself" | jq -r '.displayName')
        echo "Authenticated as: $user"
    elif grep -q "HTTP/2 401" "$DEBUG_LOG"; then
        print_error "Authentication Failed (401 Unauthorized)"
        echo "Check your token."
        echo "Full log at: $DEBUG_LOG"
    else
        print_error "Connection Failed (Unknown Error)"
        echo "Full log at: $DEBUG_LOG"
    fi
}

# List projects
cmd_projects() {
    check_config
    local result=$(jira_api GET "/project")
    
    if [[ -z "$result" ]] || [[ "$result" == "[]" ]]; then
        echo "No projects found."
        return
    fi
    echo -e "${BOLD}Key\t\tName${NC}"
    echo "----------------------------------------"
    echo "$result" | jq -r '.[] | "\(.key)\t\t\(.name)"' 2>/dev/null || echo "Error parsing JSON"
}

# List issues
cmd_list() {
    check_config
    local project="${1:-}"
    local jql="ORDER BY created DESC"
    
    if [[ -n "$project" ]]; then
        jql="project = \"$project\" $jql"
        print_header "Issues: $project"
    else
        jql="project in (ANSAIPUB, RHANSAI, BUGNOSIS) $jql"
        print_header "All Issues"
    fi
    
    local result=$(jira_api GET "/search?jql=$(echo "$jql" | jq -sRr @uri)")
    
    echo -e "${BOLD}Key\t\tStatus\t\tSummary${NC}"
    echo "──────────────────────────────────────────────────────────────"
    echo "$result" | jq -r '.issues[] | "\(.key)\t\(.fields.status.name)\t\(.fields.summary)"' 2>/dev/null | while read -r line; do
        key=$(echo "$line" | cut -f1)
        status=$(echo "$line" | cut -f2)
        summary=$(echo "$line" | cut -f3)
        
        case "$status" in
            *Done*|*Closed*) color=$GREEN ;;
            *Progress*) color=$YELLOW ;;
            *) color=$CYAN ;;
        esac
        printf "${BOLD}%s${NC}\t${color}%-12s${NC}\t%s\n" "$key" "$status" "$summary"
    done
}

# Create issue
cmd_create() {
    check_config
    local project="$1"
    local summary="$2"
    local status="${3:-To Do}"
    
    local data=$(jq -n \
        --arg proj "$project" \
        --arg sum "$summary" \
        '{
            fields: {
                project: { key: $proj },
                summary: $sum,
                issuetype: { name: "Task" }
            }
        }')
        
    local result=$(jira_api POST "/issue" "$data")
    local key=$(echo "$result" | jq -r '.key // empty')
    
    if [[ -n "$key" ]]; then
        echo -e "${GREEN}Created: $key${NC} - $summary"
        if [[ "$status" == "Done" ]]; then
            cmd_move "$key" "Done" >/dev/null
        fi
    else
        print_error "Failed to create issue"
        echo "$result"
    fi
}

# Move issue
cmd_move() {
    check_config
    local key="$1"
    local status="$2"
    
    local trans=$(jira_api GET "/issue/$key/transitions")
    local id=$(echo "$trans" | jq -r --arg s "$status" '.transitions[] | select(.name | test($s; "i")) | .id' | head -1)
    
    if [[ -n "$id" ]]; then
        local data="{\"transition\":{\"id\":\"$id\"}}"
        jira_api POST "/issue/$key/transitions" "$data"
    fi
}

# Setup command
cmd_setup() {
    print_header "Setup"
    mkdir -p "$CONFIG_DIR"
    read -p "Site: " site
    read -p "Email: " email
    echo "JIRA_SITE=\"$site\"" > "$CONFIG_FILE"
    echo "JIRA_EMAIL=\"$email\"" >> "$CONFIG_FILE"
    echo "Config saved."
}

# Main
load_config
case "${1:-help}" in
    debug) cmd_debug ;;
    projects) cmd_projects ;;
    list) cmd_list "${2:-}" ;;
    create) cmd_create "$2" "$3" "${4:-}" ;;
    move) cmd_move "$2" "$3" ;;
    setup) cmd_setup ;;
    *) echo "Usage: ansai-jira {debug|projects|list|create|move|setup}" ;;
esac

#!/usr/bin/env bash
#
# ansai-git-security-audit
# 
# ANSAI Workflow: Comprehensive Git Repository Security Audit
#
# ... (header remains same) ...

set -euo pipefail

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
REPO_PATH="${1:-.}"
AUTO_FIX="${ANSAI_AUTO_FIX:-false}"
AI_BACKEND="${ANSAI_AI_BACKEND:-}"
REPORT_FILE="${REPO_PATH}/SECURITY_AUDIT_$(date +%Y%m%d_%H%M%S).md"

# Patterns (same as before)
SENSITIVE_PATTERNS=(
    "password|passwd|pwd"
    "secret|api.*key|apikey"
    "token|auth.*token"
    "private.*key|ssh.*key"
    "\.env|environment"
    "vault"
    "192\.168\.|10\.\d+\.|172\.(1[6-9]|2[0-9]|3[01])\."
    "smtp.*password"
    "database.*url"
    "connection.*string"
)

PERSONAL_INFO_PATTERNS=(
    "@gmail\.com|@yahoo\.com|@hotmail\.com"
    "@\w+\.(com|org|net)"
    "\.local$"
    "/home/\w+"
    "C:\\\\Users\\\\\w+"
)

TEMP_FILE_PATTERNS=(
    "\.log$"
    "\.tmp$"
    "\.cache$"
    "\.bak$"
    "\.swp$|\.swo$"
    "\.pyc$|\.pyo$"
    "__pycache__"
    "node_modules"
    "\.DS_Store"
    "Thumbs\.db"
)

BUILD_ARTIFACT_PATTERNS=(
    "^site/"
    "^dist/"
    "^build/"
    "^target/"
    "^out/"
    "\.min\.js$"
    "\.min\.css$"
)

# ============================================
# Functions
# ============================================

print_header() {
    echo -e "\n${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}" >&2
    echo -e "${CYAN}â•‘                                                            â•‘${NC}" >&2
    echo -e "${CYAN}â•‘         ANSAI Git Security Audit                           â•‘${NC}" >&2
    echo -e "${CYAN}â•‘         Comprehensive Repository Security Scan             â•‘${NC}" >&2
    echo -e "${CYAN}â•‘                                                            â•‘${NC}" >&2
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n" >&2
}

check_git_repo() {
    if [[ ! -d "${REPO_PATH}/.git" ]]; then
        echo -e "${RED}âŒ Error: Not a Git repository: ${REPO_PATH}${NC}" >&2
        exit 1
    fi
}

scan_sensitive_data() {
    echo -e "${BLUE}ðŸ” Scanning for sensitive data patterns...${NC}\n" >&2
    
    local findings=0
    local finding_details=""
    
    cd "${REPO_PATH}"
    
    # Exclude markdown/docs/licenses from sensitive scan
    local files_to_scan=$(git ls-files | grep -vE "\.md$|LICENSE|CONTRIBUTING" || true)
    
    for pattern in "${SENSITIVE_PATTERNS[@]}"; do
        local matches=$(echo "$files_to_scan" | xargs grep -l -iE "$pattern" 2>/dev/null || true)
        
        if [[ -n "$matches" ]]; then
            local count=$(echo "$matches" | wc -l)
            findings=$((findings + count))
            
            echo -e "${YELLOW}âš ï¸  Found $count file(s) matching pattern: ${pattern}${NC}" >&2
            echo "$matches" | while read -r file; do
                echo -e "   ${RED}â†’${NC} $file" >&2
                finding_details+="- \`$file\`: matches pattern \`$pattern\`\n"
            done
            echo "" >&2
        fi
    done
    
    if [[ $findings -eq 0 ]]; then
        echo -e "${GREEN}âœ… No sensitive data patterns found${NC}\n" >&2
    else
        echo -e "${RED}âŒ Found $findings potential sensitive file(s)${NC}\n" >&2
    fi
    
    echo "$findings|$finding_details"
}

scan_personal_info() {
    echo -e "${BLUE}ðŸ” Scanning for personal information...${NC}\n" >&2
    
    local findings=0
    local finding_details=""
    
    cd "${REPO_PATH}"
    
    local non_doc_files=$(git ls-files | grep -v "\.md$" || true)
    
    if [[ -z "$non_doc_files" ]]; then
        echo -e "${GREEN}âœ… No non-documentation files to scan${NC}\n" >&2
        echo "0|"
        return
    fi
    
    for pattern in "${PERSONAL_INFO_PATTERNS[@]}"; do
        local matches=$(echo "$non_doc_files" | xargs grep -l -E "$pattern" 2>/dev/null || true)
        
        if [[ -n "$matches" ]]; then
            local count=$(echo "$matches" | wc -l)
            findings=$((findings + count))
            
            echo -e "${YELLOW}âš ï¸  Found $count file(s) with personal info: ${pattern}${NC}" >&2
            echo "$matches" | while read -r file; do
                echo -e "   ${YELLOW}â†’${NC} $file" >&2
                finding_details+="- \`$file\`: contains pattern \`$pattern\`\n"
            done
            echo "" >&2
        fi
    done
    
    if [[ $findings -eq 0 ]]; then
        echo -e "${GREEN}âœ… No personal information found in code${NC}\n" >&2
    else
        echo -e "${YELLOW}âš ï¸  Found $findings file(s) with personal info${NC}\n" >&2
    fi
    
    echo "$findings|$finding_details"
}

scan_temp_files() {
    echo -e "${BLUE}ðŸ” Scanning for temporary/backup files...${NC}\n" >&2
    
    local findings=0
    local finding_details=""
    
    cd "${REPO_PATH}"
    
    for pattern in "${TEMP_FILE_PATTERNS[@]}"; do
        local matches=$(git ls-files | grep -E "$pattern" 2>/dev/null || true)
        
        if [[ -n "$matches" ]]; then
            local count=$(echo "$matches" | wc -l)
            findings=$((findings + count))
            
            echo -e "${YELLOW}âš ï¸  Found $count tracked temp file(s): ${pattern}${NC}" >&2
            echo "$matches" | head -5 | while read -r file; do
                echo -e "   ${YELLOW}â†’${NC} $file" >&2
                finding_details+="- \`$file\`\n"
            done
            
            if [[ $count -gt 5 ]]; then
                echo -e "   ${YELLOW}... and $((count - 5)) more${NC}" >&2
            fi
            echo "" >&2
        fi
    done
    
    if [[ $findings -eq 0 ]]; then
        echo -e "${GREEN}âœ… No temporary files tracked${NC}\n" >&2
    else
        echo -e "${YELLOW}âš ï¸  Found $findings tracked temp file(s)${NC}\n" >&2
    fi
    
    echo "$findings|$finding_details"
}

scan_build_artifacts() {
    echo -e "${BLUE}ðŸ” Scanning for build artifacts...${NC}\n" >&2
    
    local findings=0
    local finding_details=""
    
    cd "${REPO_PATH}"
    
    for pattern in "${BUILD_ARTIFACT_PATTERNS[@]}"; do
        local matches=$(git ls-files | grep -E "$pattern" 2>/dev/null || true)
        
        if [[ -n "$matches" ]]; then
            local count=$(echo "$matches" | wc -l)
            findings=$((findings + count))
            
            echo -e "${YELLOW}âš ï¸  Found $count build artifact(s): ${pattern}${NC}" >&2
            
            local size=$(echo "$matches" | xargs du -ch 2>/dev/null | tail -1 | cut -f1 || echo "0")
            echo -e "   ${CYAN}Size: $size${NC}" >&2
            
            echo "$matches" | head -3 | while read -r file; do
                echo -e "   ${YELLOW}â†’${NC} $file" >&2
                finding_details+="- \`$file\`\n"
            done
            
            if [[ $count -gt 3 ]]; then
                echo -e "   ${YELLOW}... and $((count - 3)) more${NC}" >&2
            fi
            echo "" >&2
        fi
    done
    
    if [[ $findings -eq 0 ]]; then
        echo -e "${GREEN}âœ… No build artifacts tracked${NC}\n" >&2
    else
        echo -e "${YELLOW}âš ï¸  Found $findings build artifact(s)${NC}\n" >&2
    fi
    
    echo "$findings|$finding_details"
}

check_gitignore() {
    echo -e "${BLUE}ðŸ” Checking .gitignore coverage...${NC}\n" >&2
    
    cd "${REPO_PATH}"
    
    if [[ ! -f .gitignore ]]; then
        echo -e "${RED}âŒ No .gitignore file found!${NC}\n" >&2
        echo "missing"
        return
    fi
    
    local missing_patterns=()
    local essential=(
        "*.log"
        "*.tmp"
        ".env"
        "*.key"
        "*.pem"
        "__pycache__"
        "node_modules"
        ".DS_Store"
    )
    
    for pattern in "${essential[@]}"; do
        if ! grep -q "$pattern" .gitignore 2>/dev/null; then
            missing_patterns+=("$pattern")
        fi
    done
    
    if [[ ${#missing_patterns[@]} -eq 0 ]]; then
        echo -e "${GREEN}âœ… .gitignore has good coverage${NC}\n" >&2
        echo "good"
    else
        echo -e "${YELLOW}âš ï¸  .gitignore missing ${#missing_patterns[@]} essential pattern(s)${NC}" >&2
        for pattern in "${missing_patterns[@]}"; do
            echo -e "   ${YELLOW}â†’${NC} $pattern" >&2
        done
        echo "" >&2
        echo "incomplete|${missing_patterns[*]}"
    fi
}

get_repo_stats() {
    cd "${REPO_PATH}"
    local git_size=$(du -sh .git/ 2>/dev/null | cut -f1 || echo "unknown")
    local file_count=$(git ls-files | wc -l)
    local commit_count=$(git rev-list --count HEAD 2>/dev/null || echo "0")
    local branch=$(git branch --show-current 2>/dev/null || echo "unknown")
    echo "$git_size|$file_count|$commit_count|$branch"
}

ai_analyze_findings() {
    local sensitive_count=$1
    local personal_count=$2
    local temp_count=$3
    local artifact_count=$4
    
    if [[ -z "$AI_BACKEND" ]]; then
        return
    fi
    
    echo -e "${BLUE}ðŸ¤– Generating AI security analysis...${NC}\n" >&2
    
    local prompt="You are a security expert analyzing a Git repository audit.
Audit Results:
- Sensitive data patterns found: $sensitive_count files
- Personal information found: $personal_count files  
- Temporary files tracked: $temp_count files
- Build artifacts tracked: $artifact_count files

Provide:
1. Risk assessment (Critical/High/Medium/Low)
2. Top 3 security recommendations
3. Suggested .gitignore improvements
4. Remediation steps

Be concise and actionable."
    
    local analysis=""
    
    if [[ "$AI_BACKEND" == "litellm" ]]; then
        analysis=$(echo "$prompt" | curl -s http://localhost:4000/v1/chat/completions \
            -H "Content-Type: application/json" \
            -d '{
                "model": "gpt-4o-mini",
                "messages": [{"role": "user", "content": "'"$prompt"'"}],
                "temperature": 0.3
            }' | jq -r '.choices[0].message.content' 2>/dev/null || echo "AI analysis failed")
    elif [[ "$AI_BACKEND" == "fabric" ]]; then
        analysis=$(echo "$prompt" | fabric --pattern analyze_security 2>/dev/null || echo "AI analysis failed")
    fi
    
    if [[ -n "$analysis" && "$analysis" != "AI analysis failed" ]]; then
        echo -e "${GREEN}âœ… AI Analysis:${NC}\n" >&2
        echo "$analysis" >&2
        echo -e "\n" >&2
        echo "$analysis"
    else
        echo -e "${YELLOW}âš ï¸  AI analysis unavailable${NC}\n" >&2
        echo ""
    fi
}

generate_report() {
    local git_size=$1
    local file_count=$2
    local commit_count=$3
    local branch=$4
    local sensitive_count=$5
    local personal_count=$6
    local temp_count=$7
    local artifact_count=$8
    local ai_analysis=$9
    
    cat > "$REPORT_FILE" <<EOF
# Git Security Audit Report

**Generated by ANSAI** on $(date '+%Y-%m-%d %H:%M:%S')

## Repository Information

- **Path:** \`${REPO_PATH}\`
- **Branch:** \`${branch}\`
- **Commits:** ${commit_count}
- **Tracked Files:** ${file_count}
- **Git Size:** ${git_size}

## Security Findings

### ðŸ”´ Sensitive Data
- **Files Found:** ${sensitive_count}
- **Risk Level:** $([ $sensitive_count -gt 0 ] && echo "**CRITICAL**" || echo "Low")

### ðŸŸ¡ Personal Information
- **Files Found:** ${personal_count}
- **Risk Level:** $([ $personal_count -gt 5 ] && echo "**HIGH**" || echo "Medium")

### ðŸŸ  Temporary Files
- **Files Found:** ${temp_count}
- **Risk Level:** $([ $temp_count -gt 0 ] && echo "Medium" || echo "Low")

### ðŸ”µ Build Artifacts
- **Files Found:** ${artifact_count}
- **Risk Level:** $([ $artifact_count -gt 10 ] && echo "Medium" || echo "Low")

## Overall Assessment

**Total Issues:** $((sensitive_count + personal_count + temp_count + artifact_count))

$(if [ $sensitive_count -gt 0 ]; then
    echo "**STATUS:** âŒ CRITICAL - DO NOT MAKE PUBLIC"
    echo ""
    echo "Repository contains sensitive data that must be removed before making public."
elif [ $((personal_count + temp_count + artifact_count)) -gt 10 ]; then
    echo "**STATUS:** âš ï¸  NEEDS CLEANUP"
    echo ""
    echo "Repository has issues that should be addressed before making public."
else
    echo "**STATUS:** âœ… READY FOR PUBLIC RELEASE"
    echo ""
    echo "Repository appears clean for public distribution."
fi)

$(if [[ -n "$ai_analysis" ]]; then
    echo "## AI Security Analysis"
    echo ""
    echo "$ai_analysis"
fi)

## Recommended Actions

1. **Review all flagged files** and remove sensitive data
2. **Update .gitignore** to prevent future issues
3. **Use BFG Repo-Cleaner** to remove sensitive data from history
4. **Force push** cleaned history to remotes
5. **Rotate any exposed credentials** immediately

## Commands to Fix

\`\`\`bash
# Remove sensitive files from tracking
git rm --cached path/to/sensitive/file

# Update .gitignore
echo "pattern-to-ignore" >> .gitignore

# Clean history (use with caution!)
# Install BFG: https://rtyley.github.io/bfg-repo-cleaner/
java -jar bfg.jar --delete-files 'sensitive-file.txt' .

# Force push (after verification!)
git push origin main --force
\`\`\`

---

*Generated by [ANSAI](https://ansai.dev) - AI-Powered Automation Infrastructure*
EOF

    echo -e "${GREEN}âœ… Report saved to: ${REPORT_FILE}${NC}\n" >&2
}

main() {
    print_header
    check_git_repo
    
    echo -e "${CYAN}ðŸ“‚ Repository: ${REPO_PATH}${NC}\n" >&2
    
    local stats=$(get_repo_stats)
    IFS='|' read -r git_size file_count commit_count branch <<< "$stats"
    
    echo -e "${BLUE}Repository Stats:${NC}" >&2
    echo -e "  Branch: ${branch}" >&2
    echo -e "  Commits: ${commit_count}" >&2
    echo -e "  Files: ${file_count}" >&2
    echo -e "  Size: ${git_size}" >&2
    echo "" >&2
    
    local sensitive_result=$(scan_sensitive_data)
    local sensitive_count=$(echo "$sensitive_result" | cut -d'|' -f1)
    
    local personal_result=$(scan_personal_info)
    local personal_count=$(echo "$personal_result" | cut -d'|' -f1)
    
    local temp_result=$(scan_temp_files)
    local temp_count=$(echo "$temp_result" | cut -d'|' -f1)
    
    local artifact_result=$(scan_build_artifacts)
    local artifact_count=$(echo "$artifact_result" | cut -d'|' -f1)
    
    check_gitignore
    
    local ai_analysis=$(ai_analyze_findings "$sensitive_count" "$personal_count" "$temp_count" "$artifact_count")
    
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}" >&2
    echo -e "${CYAN}â•‘                    AUDIT SUMMARY                           â•‘${NC}" >&2
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n" >&2
    
    local total_issues=$((sensitive_count + personal_count + temp_count + artifact_count))
    
    echo -e "${BLUE}Total Issues Found: ${total_issues}${NC}" >&2
    echo -e "  ${RED}Sensitive Data:${NC} $sensitive_count" >&2
    echo -e "  ${YELLOW}Personal Info:${NC} $personal_count" >&2
    echo -e "  ${YELLOW}Temp Files:${NC} $temp_count" >&2
    echo -e "  ${YELLOW}Build Artifacts:${NC} $artifact_count" >&2
    echo "" >&2
    
    if [[ $sensitive_count -gt 0 ]]; then
        echo -e "${RED}âŒ CRITICAL: Repository contains sensitive data${NC}" >&2
        echo -e "${RED}   DO NOT make this repository public!${NC}\n" >&2
    elif [[ $total_issues -gt 10 ]]; then
        echo -e "${YELLOW}âš ï¸  WARNING: Repository needs cleanup${NC}" >&2
        echo -e "${YELLOW}   Address issues before making public${NC}\n" >&2
    else
        echo -e "${GREEN}âœ… SUCCESS: Repository appears clean${NC}" >&2
        echo -e "${GREEN}   Ready for public distribution${NC}\n" >&2
    fi
    
    generate_report "$git_size" "$file_count" "$commit_count" "$branch" \
        "$sensitive_count" "$personal_count" "$temp_count" "$artifact_count" "$ai_analysis"
    
    echo -e "${CYAN}ðŸ“„ Full report: ${REPORT_FILE}${NC}\n" >&2
    
    if [[ $sensitive_count -gt 0 ]]; then
        exit 2
    elif [[ $total_issues -gt 0 ]]; then
        exit 1
    else
        exit 0
    fi
}

main "$@"
